#! /bin/sh
EmbedMAS_HOME=/opt/EmbedMAS
EmbedMAS_TMP=/tmp/.embedMAS
mkdir -p $EmbedMAS_TMP

while getopts h:f:m:c:e:k:-: flag
do
    case "${flag}" in
        f) confFile=${OPTARG};;
        m) modeOperation=${OPTARG};;
        c) ch=${OPTARG};;
        e) name=${OPTARG};;
        k) key=${OPTARG};;
        -) opt=${OPTARG};;
    esac
done


if [ "$opt" = "help" ]; then
	cat $EmbedMAS_HOME/docs/scripts/EmbedMAS-NetworkRestart.txt
elif [ "$opt" = "forget" ]; then
	rm $EmbedMAS_HOME/conf/WLANs/lan_*.conf
fi

######################## Mode Operation #####################################
if [ "$modeOperation" = "ap" ]; then
	op1='-c random'
	op2='-e EmbedMAS'
	op3='-k NONE'

	if [ "$ch" != "" ]; then
		op1="-c $ch"
	fi

	if [ "$name" != "" ]; then
		op2="-e $name"
	fi

	if [ "$key" != "" ]; then
		op3="-k $key"
	fi
	echo 1 > $EmbedMAS_HOME/conf/apMode.conf
	$EmbedMAS_HOME/bin/lan/wpa_file_generator.sh $op1 $op2 $op3

	echo "Agendando AP WLAN Reconfigure ..."
	$EmbedMAS_HOME/bin/task/taskNew.sh "/opt/EmbedMAS/bin/EmbedMAS-NetworkRestart -f apmode"
	exit 0
elif [ "$modeOperation" = "default" ]; then
	echo 0 > $EmbedMAS_HOME/conf/apMode.conf
	$EmbedMAS_HOME/bin/lan/wpa_file_generator.sh

	echo "Agendando Default WLAN Reconfigure ..."
	$EmbedMAS_HOME/bin/task/taskNew.sh "/opt/EmbedMAS/bin/EmbedMAS-NetworkRestart -f default"
	exit 0
elif [ "$modeOperation" = "client" ]; then
	echo 0 > $EmbedMAS_HOME/conf/apMode.conf
	wpa_passphrase $name $key > $EmbedMAS_HOME/conf/WLANs/lan_$name.conf
	echo "Agendando WLAN Reconfigure ..."
	$EmbedMAS_HOME/bin/task/taskNew.sh "/opt/EmbedMAS/bin/EmbedMAS-NetworkRestart -f default"
	exit 0
fi

######################### WPA Conf ##########################################
if [ "$confFile" != "" ]; then
		systemctl stop isc-dhcp-server
		systemctl stop dhcpcd
		systemctl stop wpa_supplicant
		systemctl stop networking
	if [ "$confFile" = "default" ]; then
  		confFile="$EmbedMAS_HOME/conf/WLANs/base.conf $EmbedMAS_HOME/conf/WLANs/lan_*.conf"
 		cat $confFile > $EmbedMAS_HOME/etc/wpa_supplicant/wpa_supplicant.conf
		systemctl start networking
		systemctl start wpa_supplicant
		systemctl start dhcpcd
  	elif [ "$confFile" = "apmode" ]; then
  		confFile="$EmbedMAS_HOME/conf/WLANs/base.conf $EmbedMAS_HOME/conf/WLANs/modeApZeroConf.conf"
 		cat $confFile > $EmbedMAS_HOME/etc/wpa_supplicant/wpa_supplicant.conf
		systemctl start networking
		systemctl start wpa_supplicant
		systemctl start dhcpcd
		systemctl start isc-dhcp-server
 	fi
fi
